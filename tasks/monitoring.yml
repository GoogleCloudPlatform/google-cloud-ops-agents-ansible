---
- name: Fail if package state is not supported
  fail:
    msg: "The Cloud Ops Ansible role only supports the following package states: \"present\", and \"absent\"."
  when: package_state not in ["present", "absent"]

- block:
  - name: Download script
    get_url:
      url: https://dl.google.com/cloudagents/add-monitoring-agent-repo.sh
      dest: /tmp/add-monitoring-agent-repo.sh
      mode: 0755

  - name: Add repo
    command:
      chdir: /tmp
      cmd: bash add-monitoring-agent-repo.sh
    notify: Restart Monitoring Agent

  when: package_state == "present"

- name: Install or uninstall agent
  package:
    name: "{{ monitoring_package_name }}"
    state: "{{ package_state }}"
